<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem IPL RT RESMI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="data:application/json,{
  &quot;name&quot;:&quot;IPL RT&quot;,
  &quot;short_name&quot;:&quot;IPL RT&quot;,
  &quot;start_url&quot;:&quot;.&quot;,
  &quot;display&quot;:&quot;standalone&quot;
}">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f4f6f8;margin:0}
header{background:#0b3c91;color:#fff;padding:15px;text-align:center}
nav{padding:10px;background:#fff}
nav button{margin:4px;padding:8px;border:none;border-radius:6px}
section{display:none;padding:15px}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
.lunas{color:green;font-weight:bold}
.belum{color:red;font-weight:bold}
.kop{font-weight:bold;text-align:center}
</style>
</head>

<body>

<header>
<h2>PANCER RT 04</h2>
<p>Sistem Informasi Pembayaran IPL</p>
</header>

<nav>
<button onclick="show('dash')">Dashboard</button>
<button onclick="show('data')">Data Warga</button>
<button onclick="show('kas')">Kas</button>
<button onclick="show('qr')">QR Pembayaran</button>
<button onclick="exportExcel()">Excel</button>
<button onclick="window.print()">PDF</button>
</nav>

<section id="dash">
<h3>Dashboard IPL</h3>
<select id="bulan" onchange="loadData()">
<option>Jan</option><option>Feb</option><option>Mar</option>
<option>Apr</option><option>Mei</option><option>Jun</option>
<option>Jul</option><option>Agu</option><option>Sep</option>
<option>Okt</option><option>Nov</option><option>Des</option>
</select>
<canvas id="chartIPL"></canvas>
</section>

<section id="data">
<h3>Data Warga & Status IPL</h3>
<table id="tbl"></table>
</section>

<section id="kas">
<h3>Grafik Pengeluaran Kas</h3>
<canvas id="chartKas"></canvas>
</section>

<section id="qr">
<h3>Pembayaran IPL</h3>
<p>Scan QRIS berikut:</p>
<img src="URL_QRIS" width="220">
<p><b>Nominal: Rp 60.000</b></p>
</section>

<script>
const SHEET_WARGA="https://docs.google.com/spreadsheets/d/1YMyTMjIO-QEPlSwVVHFwz4wbi_sEVxHXKIZXIEO15Bo/edit?usp=drivesdk";
const SHEET_IPL="https://opensheet.elk.sh/ID_SHEET/PEMBAYARAN_IPL";
const SHEET_KAS="https://opensheet.elk.sh/ID_SHEET/PENGELUARAN_KAS";

function show(id){
document.querySelectorAll("section").forEach(s=>s.style.display="none");
document.getElementById(id).style.display="block";
}
show('dash');

async function loadData(){
const warga=await fetch(SHEET_WARGA).then(r=>r.json());
const bayar=await fetch(SHEET_IPL).then(r=>r.json());
const kas=await fetch(SHEET_KAS).then(r=>r.json());

let bulan=document.getElementById("bulan").value;
let paid=bayar.filter(b=>b.Bulan==bulan).map(b=>b.Nama+b.Alamat);

let lunas=0,belum=0;
let html="<tr><th>Nama</th><th>Alamat</th><th>Status</th><th>Kwitansi</th><th>WA</th></tr>";

warga.forEach((w,i)=>{
let ok=paid.includes(w.Nama+w.Alamat);
ok?lunas++:belum++;

let kw=`RT04/RW02/IPL/2026/${String(i+1).padStart(6,'0')}`;
let wa=ok?'':`<a href="https://wa.me/62${w["No HP"].substring(1)}?text=Yth%20Bpk/Ibu%20${w.Nama}%20pembayaran%20IPL%20Rp60.000%20bulan%20${bulan}%20BELUM%20LUNAS">WA</a>`;

html+=`
<tr>
<td>${w.Nama}</td>
<td>${w.Alamat}</td>
<td class="${ok?'lunas':'belum'}">${ok?'LUNAS':'BELUM'}</td>
<td>${ok?kw:'-'}</td>
<td>${wa}</td>
</tr>`;
});
document.getElementById("tbl").innerHTML=html;

// Grafik IPL
new Chart(chartIPL,{
type:'pie',
data:{labels:['Lunas','Belum'],datasets:[{data:[lunas,belum]}]}
});

// Grafik Kas
let lampu=0,cctv=0,token=0;
kas.forEach(k=>{
if(k.Jenis=='Lampu')lampu+=+k.Nominal;
if(k.Jenis=='CCTV')cctv+=+k.Nominal;
if(k.Jenis=='Token')token+=+k.Nominal;
});
new Chart(chartKas,{
type:'pie',
data:{labels:['Lampu','CCTV','Token'],datasets:[{data:[lampu,cctv,token]}]}
});
}
loadData();

function exportExcel(){
let wb=XLSX.utils.table_to_book(document.getElementById("tbl"));
XLSX.writeFile(wb,"LAPORAN_IPL_RT.xlsx");
}

// PWA
if('serviceWorker' in navigator){
navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
self.addEventListener('fetch',e=>e.respondWith(
caches.open('v1').then(c=>c.match(e.request)||fetch(e.request))
))
`],{type:'text/javascript'})));
}
</script>

</body>
</html>